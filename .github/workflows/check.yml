name: check.yml
on:
    push:
    pull_request:

jobs:
    prettier:
        runs-on: ubuntu-latest
        name: ðŸ± Prettier
        permissions:
            issues: write
            pull-requests: write
        steps:
            - name: ðŸ“¥ï¸ checkout
              uses: actions/checkout@v5

            - name: ðŸŽ›ï¸ setup
              uses: ./.github/actions/setup

            - name: ðŸ± run prettier
              run: yarn prettier:write

            - name: ðŸ”¢ count changes
              run: echo "CHANGES_COUNT=$(git status -s | wc -l)" >> $GITHUB_ENV

            - name: âœ… approve prettier result
              if: ${{ env.CHANGES_COUNT == 0 }}
              run: |
                  SUMMARY="âœ… Prettier approves code"
                  echo "# $SUMMARY" >> $GITHUB_STEP_SUMMARY
                  echo "Running prettier on $(echo ${{ github.sha }} | head -c 7) did not result in any changes. ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
                  echo "PR_SUMMARY=$SUMMARY" >> $GITHUB_ENV
                  echo "EMOJI=âœ…" >> $GITHUB_ENV

            - name: ðŸ–¨ï¸ print diff introduced by prettier
              if: ${{ env.CHANGES_COUNT > 0 }}
              run: git diff

            - name: âš ï¸ warn over prettier result
              if: ${{ env.CHANGES_COUNT > 0 }}
              run: |
                  SUMMARY="âš ï¸ Prettier changed some code".
                  echo "# $SUMMARY" >> $GITHUB_STEP_SUMMARY
                  SUMMARY="$SUMMARY Please see the summary and logs for more details."
                  echo "There were a total of **${{ env.CHANGES_COUNT }}** files affected by running prettier on $(echo ${{ github.sha }} | head -c 7):" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  git diff --compact-summary >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  echo "For a complete diff introduced by prettier, please see the workflow logs." >> $GITHUB_STEP_SUMMARY
                  echo "PR_SUMMARY=$SUMMARY" >> $GITHUB_ENV
                  echo "EMOJI=âš ï¸" >> $GITHUB_ENV

            - name: ðŸ“œ Update PR Summary
              if: github.event_name == 'pull_request'
              uses: ./.github/actions/pr-summary
              with:
                  pr-number: ${{ github.event.pull_request.number }}
                  section: prettier
                  title: ðŸŽ¨${{ env.EMOJI }} Prettier
                  content: ${{ env.PR_SUMMARY }}
                  app-id: ${{ secrets.CI_APP }}
                  app-pat: ${{ secrets.CI_PAT }}

    eslint:
        runs-on: ubuntu-latest
        name: ðŸš¨ ESLint
        permissions:
            issues: write
            pull-requests: write
            checks: write
        steps:
            - name: ðŸ“¥ï¸ checkout
              uses: actions/checkout@v5

            - name: ðŸŽ›ï¸ setup
              uses: ./.github/actions/setup

            - name: ðŸŒ create i18n types
              run: yarn i18n:once

            - name: ðŸš¨ run eslint
              run: yarn lint:fix -o .eslint-report.json --format json
              continue-on-error: true

            - name: ðŸ–¨  create annotations
              id: annotations
              uses: ataylorme/eslint-annotate-action@v3
              with:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  report-json: .eslint-report.json
                  only-pr-files: true
                  fail-on-warning: false
                  fail-on-error: true
                  check-name: ESLint Report Analysis
                  markdown-report-on-step-summary: true

            - name: ðŸ™‚ get summarizing emoji
              run: |
                  echo "EMOJI=âœ…" >> $GITHUB_ENV
                  if [[ ${{ steps.annotations.outputs.warningCount }} -gt 0 ]]; then
                    echo "EMOJI=âš ï¸" >> $GITHUB_ENV
                  fi
                  if [[ ${{ steps.annotations.outputs.errorCount }} -gt 0 ]]; then
                    echo "EMOJI=âŒ" >> $GITHUB_ENV
                  fi

            - name: ðŸ“œ update PR Summary
              if: ${{ github.event_name == 'pull_request' && always() }}
              uses: ./.github/actions/pr-summary
              with:
                  pr-number: ${{ github.event.pull_request.number }}
                  section: eslint
                  title: ðŸš¨${{ env.EMOJI }} ESLint
                  content: ${{ steps.annotations.outputs.summary }}
                  app-id: ${{ secrets.CI_APP }}
                  app-pat: ${{ secrets.CI_PAT }}
