on:
    push:
        branches:
            - main

permissions:
    contents: write
    pull-requests: write

name: release-please

jobs:
    release:
        name: 🚀 release-please
        runs-on: ubuntu-latest
        steps:
            - uses: googleapis/release-please-action@v4
              id: release
              with:
                  config-file: .release-please-config.json
                  manifest-file: .release-please-manifest.json
        outputs:
            released: ${{ steps.release.outputs.release_created }}
            tag: ${{ steps.release.outputs.tag_name }}

    find-configs:
        name: 📇 find configs
        needs:
            - release
        if: ${{ needs.release.outputs.released }}
        uses: ./.github/workflows/find-configs.yml

    assets:
        name: 📤️ build and upload release assets
        runs-on: ubuntu-latest
        needs:
            - release
            - find-configs
        strategy:
            matrix:
                config: ${{ fromJson(needs.find-configs.outputs.configs) }}
            fail-fast: false
        steps:
            - name: 📥️ checkout
              uses: actions/checkout@v5

            - name: 🏗️ build
              id: build
              uses: ./.github/actions/build
              with:
                  config: ${{ matrix.config }}
                  release: true

            - name: 📤 upload release artifacts
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # get meta filename
                  file="${{ steps.build.outputs.script }}"
                  meta="${{ steps.build.outputs.meta }}"
                  polyfills="${{ steps.build.outputs.polyfills }}"

                  # upload the release artifacts with special nice names
                  gh release upload ${{ needs.release.outputs.tag }} \
                    "${{ steps.build.outputs.dir }}/$file#➡️ [${{ matrix.config }}] ${{ needs.release.outputs.tag }}.user.js" \
                    "${{ steps.build.outputs.dir }}/$meta#[${{ matrix.config }}] ${{ needs.release.outputs.tag }}.meta.js" \
                    "${{ steps.build.outputs.dir }}/$polyfills#[${{ matrix.config }}] ${{ needs.release.outputs.tag }}.polyfills.js"

            # legacy release for uzl, please remove this at earliest in October 2025
            - name: 📤 upload legacy uzl artifact
              if: ${{ matrix.config == 'uzl' }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  file="${{ steps.build.outputs.script }}"
                  meta="${{ steps.build.outputs.meta }}"
                  cp "${{ steps.build.outputs.dir }}/$file" better-moodle.user.js
                  cp "${{ steps.build.outputs.dir }}/$meta" better-moodle.meta.js

                  # upload the releases
                  gh release upload ${{ needs.release.outputs.tag }} \
                      "better-moodle.user.js#Legacy uzl userscript" \
                      "better-moodle.meta.js#Legacy uzl meta file"
