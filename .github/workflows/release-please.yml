on:
    push:
        branches:
            - main

permissions:
    contents: write
    pull-requests: write

name: release-please

jobs:
    release:
        name: 🚀 release-please
        runs-on: ubuntu-latest
        steps:
            - uses: googleapis/release-please-action@v4
              id: release
              with:
                  config-file: .release-please-config.json
                  manifest-file: .release-please-manifest.json
        outputs:
            released: ${{ steps.release.outputs.release_created }}
            tag: ${{ steps.release.outputs.tag_name }}

    find-configs:
        name: 📇 find configs
        needs:
            - release
        if: ${{ needs.release.outputs.released }}
        uses: ./.github/workflows/find-configs.yml

    assets:
        name: 📤️ build and upload release assets
        runs-on: ubuntu-latest
        needs:
            - release
            - find-configs
        strategy:
            matrix:
                config: ${{ fromJson(needs.find-configs.outputs.configs) }}
        steps:
            - name: 📥️ checkout
              uses: actions/checkout@v5

            - name: 🏗️ build
              id: build
              uses: ./.github/actions/build
              with:
                  config: ${{ matrix.config }}
                  release: true

            - name: 📤 upload release artifacts
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # get meta filename
                  file="${{ steps.build.outputs.file }}"
                  meta=$(sed 's/\.user\.js/\.meta\.user\.js/' <<< "$file")
                  polyfills=$(sed 's/\.user\.js/-polyfills\.js/' <<< "$file")

                  # upload the release artifacts with special nice names
                  gh release upload ${{ needs.release.outputs.tag }} \
                    "${{ steps.build.outputs.dir }}/$file#[${{ matrix.config }}] Better-Moodle userscript version ${{ steps.release.outputs.tag_name }} ($file)" \
                    "${{ steps.build.outputs.dir }}/$meta#[${{ matrix.config }}] Better-Moodle meta file for userscript managers ($meta)" \
                    "${{ steps.build.outputs.dir }}/$polyfills#[${{ matrix.config }}] Polyfills for Better-Moodle version ${{ steps.release.outputs.tag_name }} ($polyfills)"

            # legacy release for uzl, please remove this at earliest in October 2025
            - name: 📤 upload legacy uzl artifact
              if: ${{ matrix.config == 'uzl' }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  file="${{ steps.build.outputs.file }}"
                  meta=$(sed 's/\.user\.js/\.meta\.user\.js/' <<< "$file")
                  cp "${{ steps.build.outputs.dir }}/$file" better-moodle.user.js
                  cp "${{ steps.build.outputs.dir }}/$meta" better-moodle.meta.js

                  # upload the releases
                  gh release upload ${{ needs.release.outputs.tag }} \
                      "better-moodle.user.js#Legacy uzl userscript" \
                      "better-moodle.meta.js#Legacy uzl meta file"
