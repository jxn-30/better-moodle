name: build.yml
on:
    push:
        branches:
            - v2
    pull_request:
        branches:
            - v2

jobs:
    find-configs:
        name: ğŸ“‡ Find configs
        uses: ./.github/workflows/find-configs.yml

    build:
        runs-on: ubuntu-latest
        name: ğŸ—ï¸ Build
        needs:
            - find-configs
        strategy:
            matrix:
                config: ${{ fromJson(needs.find-configs.outputs.configs) }}
        permissions:
            id-token: write
            attestations: write
        outputs:
            stats: ${{ toJSON(steps.output.outputs) }}
        steps:
            - name: ğŸ“¥ï¸ checkout
              uses: actions/checkout@v4

            - name: ğŸ— build Better-Moodle for ${{ matrix.config }}
              id: build
              uses: ./.github/actions/build
              with:
                  config: ${{ matrix.config }}

            - name: ğŸ¦­ attest build provenance
              uses: actions/attest-build-provenance@v2
              with:
                  subject-name: ${{ steps.build.outputs.file }}
                  subject-digest: sha256:${{ steps.build.outputs.digest }}
                  show-summary: true

            - name: ğŸ“Š aggregate build statistics
              run: |
                  echo "STATS_SIZE=$(ls -sh --si '${{ steps.build.outputs.dir }}/${{ steps.build.outputs.file }}' | awk '{print $1}')B" >> $GITHUB_ENV
                  echo "STATS_LINES=$(wc -l '${{ steps.build.outputs.dir }}/${{ steps.build.outputs.file }}' | awk '{print $1}')" >> $GITHUB_ENV
                  echo "STATS_PERF_CONF=$(cat ${{ steps.build.outputs.dir }}/.stats_perf_conf)" >> $GITHUB_ENV
                  echo "STATS_PERF_BUILD=$(cat ${{ steps.build.outputs.dir }}/.stats_perf_build)" >> $GITHUB_ENV
                  echo "STATS_PERF_TOTAL=$(cat ${{ steps.build.outputs.dir }}/.stats_perf_total)" >> $GITHUB_ENV

            - name: âœï¸ print build stats in summary
              run: |
                  echo "# ğŸ—ï¸ ${{ matrix.config }}" >> $GITHUB_STEP_SUMMARY
                  echo "## Built file: \`${{ steps.build.outputs.file }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------:|:------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **File size** | ${{ env.STATS_SIZE }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Line count** | ${{ env.STATS_LINES }} |" >> $GITHUB_STEP_SUMMARY

                  echo "## Build stats" >> $GITHUB_STEP_SUMMARY
                  echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------:|:------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Creating config duration** | ${{ env.STATS_PERF_CONF }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Building duration** | ${{ env.STATS_PERF_BUILD }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Total duration** | **${{ env.STATS_PERF_TOTAL }}** |" >> $GITHUB_STEP_SUMMARY
                  echo "*Durations are mm:ss,s*"

                  echo "## Included features" >> $GITHUB_STEP_SUMMARY
                  cat ${{ steps.build.outputs.dir }}/.stats_features.md >> $GITHUB_STEP_SUMMARY

            - name: ğŸ“ generate output
              id: output
              run: |
                  echo "build_${{ matrix.config }}=| ${{matrix.config}} | ${{ env.STATS_SIZE }} | ${{ env.STATS_LINES }} | ${{ env.STATS_PERF_TOTAL }} |" >> $GITHUB_OUTPUT

    pr-summary:
        runs-on: ubuntu-latest
        name: ğŸ“œ update PR Summary
        if: ${{ github.event_name == 'pull_request' && always() }}
        needs:
            - build
        steps:
            - name: ğŸ“¥ï¸ checkout
              uses: actions/checkout@v4

            - name: ğŸ“œ update PR Summary
              uses: ./.github/actions/pr-summary
              with:
                  pr-number: ${{ github.event.pull_request.number }}
                  section: ğŸ—ï¸  Build
                  content: |
                      \`\`\`json
                      ${{ needs.build.outputs.stats }}
                      \`\`\`
